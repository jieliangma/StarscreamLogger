<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆûÊó∂Êó•ÂøóÊü•ÁúãÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            background: #1e1e1e;
            color: #e0e0e0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        h1 {
            color: #4d9fff;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1 1 auto;
        }
        
        .control-group label {
            font-size: 14px;
            color: #999;
        }

        .control-group:first-child {
            flex: 2 1 auto; /* ÊêúÁ¥¢Ê°ÜÁªÑÂç†Áî®Êõ¥Â§öÁ©∫Èó¥ */
        }
        
        input[type="text"],
        select {
            padding: 8px 12px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
            font-family: inherit;
        }
        
        input[type="text"] {
            min-width: 200px;
            flex: 1;
            width: 100%;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #4d9fff;
        }
        
        select {
            min-width: 120px;
        }
        
        button {
            padding: 8px 16px;
            background: #4d9fff;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #3a8eef;
        }
        
        button:active {
            background: #2a7edf;
        }
        
        /* Êñ∞Â¢ûÔºöÊ≠£ÂàôÂºÄÂÖ≥Ê†∑Âºè */
        .regex-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #999;
        }
        
        .regex-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #4d9fff;
            cursor: pointer;
        }
        
        .status-bar {
            color: #ff6347;
            margin-bottom: 16px;
            font-size: 12px;
            padding: 8px;
            background: #2d2d2d;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-bar.connected {
            color: #32cd32;
        }
        
        /* Êñ∞Â¢ûÔºöÊ≠£ÂàôÈîôËØØÊèêÁ§∫Ê†∑Âºè */
        .regex-error {
            color: #ff6347;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .log-stats {
            font-size: 12px;
            color: #999;
        }
        
        .log-container {
            flex: 1;
            overflow-y: auto;
            background: #252526;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #3d3d3d;
        }
        
        .log-item {
            margin: 4px 0;
            font-size: 13px;
            line-height: 1.5;
            padding: 4px 8px;
            border-radius: 3px;
            word-wrap: break-word;
            transition: background 0.1s;
        }
        
        .log-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .log-item.hidden {
            display: none;
        }
        
        .log-verbose { color: #cccccc; }
        .log-debug { color: #6495ed; }
        .log-info { color: #32cd32; }
        .log-warn { color: #ffd700; }
        .log-error { color: #ff6347; font-weight: 500; }
        
        .log-time {
            color: #858585;
            margin-right: 12px;
            font-size: 12px;
        }
        
        .log-level {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 8px;
            min-width: 60px;
            text-align: center;
        }
        
        .log-level.verbose { background: #666; color: #fff; }
        .log-level.debug { background: #4169e1; color: #fff; }
        .log-level.info { background: #228b22; color: #fff; }
        .log-level.warn { background: #daa520; color: #000; }
        .log-level.error { background: #dc143c; color: #fff; }
        
        .log-message {
            flex: 1;
        }
        
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="control-group">
            <label>ÊêúÁ¥¢:</label>
            <input type="text" id="searchInput" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆÂ≠ó/Ê≠£ÂàôË°®ËææÂºèÊêúÁ¥¢...">
            <!-- Êñ∞Â¢ûÔºöÊ≠£ÂàôÂºÄÂÖ≥Â§çÈÄâÊ°Ü -->
            <div class="regex-toggle">
                <input type="checkbox" id="regexToggle">
                <label for="regexToggle">Ê≠£ÂàôË°®ËææÂºè</label>
            </div>
            <span id="regexError" class="regex-error"></span>
        </div>
        
        <div>
            <label>Á∫ßÂà´:</label>
            <select id="levelFilter">
                <option value="all">ÂÖ®ÈÉ®Á∫ßÂà´</option>
                <option value="verbose">Verbose</option>
                <option value="debug">Debug</option>
                <option value="info">Info</option>
                <option value="warn">Warning</option>
                <option value="error">Error</option>
            </select>
        </div>
        
        <button id="clearButton">Ê∏ÖÁ©∫Êó•Âøó</button>
        <button id="autoScrollButton">Ëá™Âä®ÊªöÂä®: ÂºÄ</button>
    </div>
    
    <div class="status-bar" id="status">
        <span>Ê≠£Âú®ËøûÊé•ËÆæÂ§á...</span>
        <span class="log-stats" id="logStats">0 Êù°Êó•Âøó</span>
    </div>
    
    <div class="log-container" id="logContainer"></div>

    <script>
        const statusEl = document.getElementById('status');
        const logContainer = document.getElementById('logContainer');
        const searchInput = document.getElementById('searchInput');
        const levelFilter = document.getElementById('levelFilter');
        const clearButton = document.getElementById('clearButton');
        const autoScrollButton = document.getElementById('autoScrollButton');
        const logStats = document.getElementById('logStats');
        // Êñ∞Â¢ûÔºöÊ≠£ÂàôÁõ∏ÂÖ≥ÂÖÉÁ¥†
        const regexToggle = document.getElementById('regexToggle');
        const regexError = document.getElementById('regexError');
        
        let webSocket = null;
        let logs = [];
        let autoScroll = true;
        let searchText = '';
        let filterLevel = 'all';
        // Êñ∞Â¢ûÔºöÊ≠£ÂàôÂºÄÂÖ≥Áä∂ÊÄÅ„ÄÅÊ≠£ÂàôÂØπË±°ÁºìÂ≠ò
        let isRegexSearch = false;
        let regexPattern = null; // ÁºìÂ≠òÁºñËØëÂêéÁöÑÊ≠£ÂàôÂØπË±°ÔºåÈÅøÂÖçÈáçÂ§çÁºñËØë
        // Êñ∞Â¢ûÔºöÈáçËøûÁõ∏ÂÖ≥ÂèòÈáè
        let reconnectTimer = null; // ÈáçËøûÂÆöÊó∂Âô®
        const reconnectInterval = 5000; // ÈáçËøûÈó¥ÈöîÔºà5ÁßíÔºâ
        
        // ÂàùÂßãÂåñ WebSocket ËøûÊé•
        function initWebSocket() {
            // ‰ΩøÁî®Âç†‰ΩçÁ¨¶ÔºåÂ∞ÜÂú®ÊúçÂä°Âô®Á´ØÊõøÊç¢‰∏∫ÂÆûÈôÖ IP ÂíåÁ´ØÂè£
            const wsUrl = '{{WS_URL}}/ws';
            webSocket = new WebSocket(wsUrl, 'default');

            webSocket.onopen = () => {
                // Êñ∞Â¢ûÔºöËøûÊé•ÊàêÂäüÂêéÊ∏ÖÈô§ÈáçËøûÂÆöÊó∂Âô®
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
                statusEl.textContent = "‚úÖ Â∑≤ËøûÊé•Âà∞ËÆæÂ§áÔºåÊ≠£Âú®Êé•Êî∂Êó•Âøó...";
                statusEl.className = "status-bar connected";
            };

            webSocket.onmessage = (event) => {
                try {
                    const logData = JSON.parse(event.data);
                    addLog(logData);
                } catch (e) {
                    // Â¶ÇÊûú‰∏çÊòØ JSONÔºå‰Ωú‰∏∫Á∫ØÊñáÊú¨Â§ÑÁêÜ
                    addLog({
                        level: 'info',
                        levelName: 'info',
                        message: event.data,
                        timestamp: Date.now() / 1000,
                        timeString: new Date().toLocaleTimeString(),
                        file: '',
                        function: '',
                        line: 0
                    });
                }
            };

            webSocket.onclose = () => {
                statusEl.textContent = "‚ùå ËøûÊé•Êñ≠ÂºÄ";
                statusEl.className = "status-bar";
                // Êñ∞Â¢ûÔºöËß¶ÂèëÈáçËøûÈÄªËæë
                reconnectWebSocket();
            };

            webSocket.onerror = (error) => {
                statusEl.textContent = `‚ùå ËøûÊé•ÈîôËØØÔºö${error.message || 'Êú™Áü•ÈîôËØØ'}`;
                statusEl.className = "status-bar";
                // Êñ∞Â¢ûÔºöÈîôËØØÂêé‰πüËß¶ÂèëÈáçËøûÔºàÂèØÈÄâÔºåÂ¢ûÂº∫È≤ÅÊ£íÊÄßÔºâ
                reconnectWebSocket();
            };
        }

        // Êñ∞Â¢ûÔºöÁºñËØëÊ≠£ÂàôË°®ËææÂºèÔºàÂ∏¶ÈîôËØØÂ§ÑÁêÜÔºâ
        function compileRegex(patternStr) {
            regexError.textContent = '';
            if (!patternStr) return null;
            
            try {
                // ÂøΩÁï•Â§ßÂ∞èÂÜôÔºåÂÖ®Â±ÄÂåπÈÖç
                return new RegExp(patternStr, 'i');
            } catch (e) {
                regexError.textContent = `Ê≠£ÂàôÈîôËØØ: ${e.message}`;
                return null;
            }
        }

        // Êñ∞Â¢ûÔºöWebSocketÈáçËøûÂáΩÊï∞
        function reconnectWebSocket() {
            // ÈÅøÂÖçÈáçÂ§çÂàõÂª∫ÂÆöÊó∂Âô®
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
            }
            
            // ÊòæÁ§∫ÈáçËøûÊèêÁ§∫
            statusEl.textContent = `‚ùå ËøûÊé•Êñ≠ÂºÄÔºå${reconnectInterval/1000}ÁßíÂêéÂ∞ùËØïÈáçËøû...`;
            
            // ËÆæÁΩÆ5ÁßíÂêéÈáçÊñ∞ÂàùÂßãÂåñËøûÊé•
            reconnectTimer = setTimeout(() => {
                statusEl.textContent = "üîÑ Ê≠£Âú®Â∞ùËØïÈáçÊñ∞ËøûÊé•...";
                initWebSocket();
            }, reconnectInterval);
        }

        // Ê∑ªÂä†Êó•Âøó
        function addLog(logData) {
            logs.push(logData);
            const logItem = createLogElement(logData);
            
            // Â∫îÁî®ÂΩìÂâçËøáÊª§Êù°‰ª∂
            if (shouldShowLog(logData)) {
                logContainer.appendChild(logItem);
                if (autoScroll) {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
            } else {
                logItem.classList.add('hidden');
                logContainer.appendChild(logItem);
            }
            
            updateLogStats();
        }

        // ÂàõÂª∫Êó•ÂøóÂÖÉÁ¥†
        function createLogElement(logData) {
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${logData.levelName.toLowerCase()}`;
            logItem.setAttribute('data-level', logData.levelName.toLowerCase());
            logItem.setAttribute('data-message', logData.message.toLowerCase());
            // Êñ∞Â¢ûÔºöÂ≠òÂÇ®ÂéüÂßãÊ∂àÊÅØÔºàÁî®‰∫éÊ≠£ÂàôÂåπÈÖçÔºâ
            logItem.setAttribute('data-message-raw', logData.message);
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = `[${logData.timeString || formatTime(logData.timestamp)}]`;
            
            const levelSpan = document.createElement('span');
            levelSpan.className = `log-level ${logData.levelName.toLowerCase()}`;
            levelSpan.textContent = logData.levelName.toUpperCase();
            
            const messageSpan = document.createElement('span');
            messageSpan.className = 'log-message';
            messageSpan.textContent = logData.message;
            
            logItem.appendChild(timeSpan);
            logItem.appendChild(levelSpan);
            logItem.appendChild(messageSpan);
            
            if (logData.file && logData.line > 0) {
                logItem.title = `${logData.file}:${logData.line}`
            }
            
            return logItem;
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            const ms = String(date.getMilliseconds()).padStart(3, '0');
            return `${hours}:${minutes}:${seconds}.${ms}`;
        }

        // ‰øÆÊîπÔºöÊõ¥Êñ∞Êó•ÂøóËøáÊª§ÈÄªËæëÔºåÊîØÊåÅÊ≠£Âàô
        function shouldShowLog(logData) {
            // Á∫ßÂà´ËøáÊª§
            if (filterLevel !== 'all' && logData.levelName.toLowerCase() !== filterLevel) {
                return false;
            }
            
            // ÊêúÁ¥¢ËøáÊª§
            if (searchText) {
                const message = logData.message;
                const file = logData.file || '';
                const func = logData.function || '';
                
                if (isRegexSearch) {
                    // Ê≠£ÂàôÊ®°ÂºèÔºö‰ΩøÁî®ÁºñËØëÂ•ΩÁöÑÊ≠£ÂàôÂØπË±°ÂåπÈÖç
                    if (!regexPattern) return false;
                    return regexPattern.test(message) || regexPattern.test(file) || regexPattern.test(func);
                } else {
                    // ÊôÆÈÄöÊ®°ÂºèÔºöÂåÖÂê´ÂåπÈÖçÔºàÂÖºÂÆπÂéüÊúâÈÄªËæëÔºâ
                    const searchLower = searchText.toLowerCase();
                    const messageLower = message.toLowerCase();
                    const fileLower = file.toLowerCase();
                    const funcLower = func.toLowerCase();
                    
                    return messageLower.includes(searchLower) ||
                           fileLower.includes(searchLower) ||
                           funcLower.includes(searchLower);
                }
            }
            
            return true;
        }

        // ‰øÆÊîπÔºöÈáçÊñ∞ËøáÊª§ÊâÄÊúâÊó•ÂøóÔºàÈÄÇÈÖçÊ≠£ÂàôÔºâ
        function refilterLogs() {
            // ÂÖàÁºñËØëÊ≠£ÂàôÔºàÂ¶ÇÊûúÂºÄÂêØÔºâ
            if (isRegexSearch) {
                regexPattern = compileRegex(searchText);
            } else {
                regexPattern = null;
                regexError.textContent = '';
            }
            
            const items = logContainer.querySelectorAll('.log-item');
            items.forEach(item => {
                const level = item.getAttribute('data-level');
                const messageRaw = item.getAttribute('data-message-raw');
                const file = item.title.split(':')[0] || '';
                const func = ''; // ÂéüÊúâÈÄªËæëÊú™Â≠òÂÇ®funcÔºåËøôÈáå‰øùÊåÅ‰∏ÄËá¥
                
                let shouldShow = true;
                
                // Á∫ßÂà´ËøáÊª§
                if (filterLevel !== 'all' && level !== filterLevel) {
                    shouldShow = false;
                }
                
                // ÊêúÁ¥¢ËøáÊª§
                if (searchText && shouldShow) {
                    if (isRegexSearch) {
                        // Ê≠£ÂàôÂåπÈÖç
                        if (!regexPattern) {
                            shouldShow = false;
                        } else {
                            shouldShow = regexPattern.test(messageRaw) ||
                                       regexPattern.test(file) ||
                                       regexPattern.test(func);
                        }
                    } else {
                        // ÊôÆÈÄöÂåÖÂê´ÂåπÈÖç
                        const messageLower = item.getAttribute('data-message');
                        const searchLower = searchText.toLowerCase();
                        shouldShow = messageLower.includes(searchLower) ||
                                   file.toLowerCase().includes(searchLower);
                    }
                }
                
                if (shouldShow) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
            
            updateLogStats();
        }

        // Êõ¥Êñ∞Êó•ÂøóÁªüËÆ°
        function updateLogStats() {
            const visibleCount = logContainer.querySelectorAll('.log-item:not(.hidden)').length;
            logStats.textContent = `${visibleCount} / ${logs.length} Êù°Êó•Âøó`;
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        searchInput.addEventListener('input', (e) => {
            searchText = e.target.value.trim();
            refilterLogs();
        });

        // Êñ∞Â¢ûÔºöÊ≠£ÂàôÂºÄÂÖ≥ÂàáÊç¢‰∫ã‰ª∂
        regexToggle.addEventListener('change', (e) => {
            isRegexSearch = e.target.checked;
            // ÂàáÊç¢ÂêéÈáçÊñ∞ËøáÊª§
            refilterLogs();
        });

        levelFilter.addEventListener('change', (e) => {
            filterLevel = e.target.value;
            refilterLogs();
        });

        clearButton.addEventListener('click', () => {
            logs = [];
            logContainer.innerHTML = '';
            updateLogStats();
        });

        autoScrollButton.addEventListener('click', () => {
            autoScroll = !autoScroll;
            autoScrollButton.textContent = `Ëá™Âä®ÊªöÂä®: ${autoScroll ? 'ÂºÄ' : 'ÂÖ≥'}`;
            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        });

        // Êñ∞Â¢ûÔºöÈ°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®ÂíåËøûÊé•ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÊºè
        window.addEventListener('beforeunload', () => {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
            }
            if (webSocket) {
                webSocket.close();
            }
        });

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂàùÂßãÂåñ
        window.onload = () => {
            initWebSocket();
        };
    </script>
</body>
</html>
